<!DOCTYPE HTML>
<html lang="zh-CN" class="sidebar-visible no-js light">

<head>
    <!-- Book generated using mdBook -->
    <meta charset="UTF-8">
    <title>线程管理 - 棒棒彬的第二大脑</title>
    <!-- Custom HTML head -->
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#ffffff" />

    <link rel="icon" href="../../favicon.svg">
    <link rel="shortcut icon" href="../../favicon.png">
    <link rel="stylesheet" href="../../css/variables.css">
    <link rel="stylesheet" href="../../css/general.css">
    <link rel="stylesheet" href="../../css/chrome.css">
    <link rel="stylesheet" href="../../css/print.css" media="print">
    <!-- Fonts -->
    <link rel="stylesheet" href="../../FontAwesome/css/font-awesome.css">
    <link rel="stylesheet" href="../../fonts/fonts.css">
    <!-- Highlight.js Stylesheets -->
    <link rel="stylesheet" href="../../highlight.css">
    <link rel="stylesheet" href="../../tomorrow-night.css">
    <link rel="stylesheet" href="../../ayu-highlight.css">

    <!-- Custom theme stylesheets -->
</head>

<body>
    <!-- Provide site root to javascript -->
    <script type="text/javascript">
        var path_to_root = "../../";
        var default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? "navy" : "light";
    </script>

    <!-- Work around some values being stored in localStorage wrapped in quotes -->
    <script type="text/javascript">
        try {
            var theme = localStorage.getItem('mdbook-theme');
            var sidebar = localStorage.getItem('mdbook-sidebar');

            if (theme.startsWith('"') && theme.endsWith('"')) {
                localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
            }

            if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
            }
        } catch (e) { }
    </script>

    <!-- Set the theme before any content is loaded, prevents flash -->
    <script type="text/javascript">
        var theme;
        try { theme = localStorage.getItem('mdbook-theme'); } catch (e) { }
        if (theme === null || theme === undefined) { theme = default_theme; }
        var html = document.querySelector('html');
        html.classList.remove('no-js')
        html.classList.remove('light')
        html.classList.add(theme);
        html.classList.add('js');
    </script>

    <!-- Hide / unhide sidebar before it is displayed -->
    <script type="text/javascript">
        var html = document.querySelector('html');
        var sidebar = 'hidden';
        if (document.body.clientWidth >= 1080) {
            try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch (e) { }
            sidebar = sidebar || 'visible';
        }
        html.classList.remove('sidebar-visible');
        html.classList.add("sidebar-" + sidebar);
    </script>

    <nav id="sidebar" class="sidebar" aria-label="Table of contents">
        <div class="sidebar-scrollbox">
            <ol class="chapter"><li class="chapter-item expanded affix "><a href="../../Introduction.html">首页</a></li><li class="chapter-item expanded affix "><a href="../../meta/meta.html">元信息</a></li><li class="spacer"></li><li class="chapter-item expanded "><a href="../../education/education.html"><strong aria-hidden="true">1.</strong> 终身学习&amp;通识教育</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../education/reading/reading.html"><strong aria-hidden="true">1.1.</strong> 通识阅读</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../education/reading/a-whole-new-mind.html"><strong aria-hidden="true">1.1.1.</strong> 《全新思维》</a></li><li class="chapter-item expanded "><a href="../../education/reading/act-like-a-leader.html"><strong aria-hidden="true">1.1.2.</strong> 《能力陷阱》</a></li></ol></li><li class="chapter-item expanded "><a href="../../education/language.html"><strong aria-hidden="true">1.2.</strong> 世界语言</a></li><li class="chapter-item expanded "><div><strong aria-hidden="true">1.3.</strong> 知识管理</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../education/anki.html"><strong aria-hidden="true">1.3.1.</strong> Anki</a></li><li class="chapter-item expanded "><a href="../../education/second-brain-podcast.html"><strong aria-hidden="true">1.3.2.</strong> 构建第二大脑播客</a></li></ol></li><li class="chapter-item expanded "><a href="../../productivity/productivity.html"><strong aria-hidden="true">1.4.</strong> 时间管理</a></li><li class="chapter-item expanded "><a href="../../education/tedxmit.html"><strong aria-hidden="true">1.5.</strong> TEDxMIT</a></li></ol></li><li class="chapter-item expanded "><a href="../../infrastructure/infrastructure.html"><strong aria-hidden="true">2.</strong> 基础利器</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../macOS/macOS.html"><strong aria-hidden="true">2.1.</strong> macOS</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../macOS/alfred.html"><strong aria-hidden="true">2.1.1.</strong> Alfred</a></li><li class="chapter-item expanded "><a href="../../macOS/snippetsLab.html"><strong aria-hidden="true">2.1.2.</strong> SnippetsLab</a></li><li class="chapter-item expanded "><a href="../../macOS/contexts.html"><strong aria-hidden="true">2.1.3.</strong> Contexts</a></li><li class="chapter-item expanded "><a href="../../macOS/homebrew.html"><strong aria-hidden="true">2.1.4.</strong> Homebrew</a></li><li class="chapter-item expanded "><a href="../../macOS/clion.html"><strong aria-hidden="true">2.1.5.</strong> CLion</a></li></ol></li><li class="chapter-item expanded "><a href="../../linux/linux.html"><strong aria-hidden="true">2.2.</strong> Linux</a></li><li class="chapter-item expanded "><a href="../../cli/cli.html"><strong aria-hidden="true">2.3.</strong> 命令行</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../cli/vim.html"><strong aria-hidden="true">2.3.1.</strong> Vim</a></li><li class="chapter-item expanded "><a href="../../cli/git-quick-checklist.html"><strong aria-hidden="true">2.3.2.</strong> Git 常用命令速查清单</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../cs/cs.html"><strong aria-hidden="true">3.</strong> 计算机科学</a></li><li><ol class="section"><li class="chapter-item expanded "><div><strong aria-hidden="true">3.1.</strong> 课程记录</div></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../cs/class/cs110l.html"><strong aria-hidden="true">3.1.1.</strong> CS 110L: Safety in Systems Programming</a></li><li class="chapter-item expanded "><a href="../../cs/class/missing-semester.html"><strong aria-hidden="true">3.1.2.</strong> The Missing Semester of Your CS Education</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../cs/class/missing-semester/course-shell.html"><strong aria-hidden="true">3.1.2.1.</strong> Course overview + the shell</a></li><li class="chapter-item expanded "><a href="../../cs/class/missing-semester/shell-tools.html"><strong aria-hidden="true">3.1.2.2.</strong> Shell Tools and Scripting</a></li><li class="chapter-item expanded "><a href="../../cs/class/missing-semester/editors.html"><strong aria-hidden="true">3.1.2.3.</strong> Editors (Vim)</a></li><li class="chapter-item expanded "><a href="../../cs/class/missing-semester/data-wrangling.html"><strong aria-hidden="true">3.1.2.4.</strong> Data Wrangling</a></li><li class="chapter-item expanded "><a href="../../cs/class/missing-semester/command-line.html"><strong aria-hidden="true">3.1.2.5.</strong> Command-line Environment</a></li><li class="chapter-item expanded "><a href="../../cs/class/missing-semester/version-control.html"><strong aria-hidden="true">3.1.2.6.</strong> Version Control (Git)</a></li><li class="chapter-item expanded "><a href="../../cs/class/missing-semester/debugging-profiling.html"><strong aria-hidden="true">3.1.2.7.</strong> Debugging and Profiling</a></li><li class="chapter-item expanded "><a href="../../cs/class/missing-semester/metaprogramming.html"><strong aria-hidden="true">3.1.2.8.</strong> Metaprogramming</a></li><li class="chapter-item expanded "><a href="../../cs/class/missing-semester/security.html"><strong aria-hidden="true">3.1.2.9.</strong> Security and Cryptography</a></li><li class="chapter-item expanded "><a href="../../cs/class/missing-semester/potpourri.html"><strong aria-hidden="true">3.1.2.10.</strong> Potpourri</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../programming-languages/programming-languages.html"><strong aria-hidden="true">3.2.</strong> 编程语言</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../programming-languages/swift/swift.html"><strong aria-hidden="true">3.2.1.</strong> Swift</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../programming-languages/swift/what's-new-5-4.html"><strong aria-hidden="true">3.2.1.1.</strong> Swift 5.4 新特性速查</a></li><li class="chapter-item expanded "><a href="../../programming-languages/swift/advanced-swift.html"><strong aria-hidden="true">3.2.1.2.</strong> 《Swift 进阶》阅读纪要</a></li><li class="chapter-item expanded "><a href="../../programming-languages/swift/swift-method-dispatch-notes.html"><strong aria-hidden="true">3.2.1.3.</strong> Swift 方法派发纪要</a></li><li class="chapter-item expanded "><a href="../../programming-languages/swift/concurrency.html"><strong aria-hidden="true">3.2.1.4.</strong> Concurrency</a></li></ol></li><li class="chapter-item expanded "><a href="../../programming-languages/rust/rust.html"><strong aria-hidden="true">3.2.2.</strong> Rust</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../programming-languages/rust/insights_about_rust.html"><strong aria-hidden="true">3.2.2.1.</strong> 认识与感受 Rust 的红与黑</a></li><li class="chapter-item expanded "><a href="../../programming-languages/rust/concepts/proc_macro.html"><strong aria-hidden="true">3.2.2.2.</strong> 过程宏</a></li><li class="chapter-item expanded "><a href="../../programming-languages/rust/concepts/closure.html"><strong aria-hidden="true">3.2.2.3.</strong> 化解神奇的闭包</a></li><li class="chapter-item expanded "><a href="../../programming-languages/rust/concepts/interior_mutability_and_cells.html"><strong aria-hidden="true">3.2.2.4.</strong> Rust 中的可变与不可变以及 Cell 的使用</a></li><li class="chapter-item expanded "><a href="../../programming-languages/rust/concepts/move_copy_borrow.html"><strong aria-hidden="true">3.2.2.5.</strong> Move&amp;Copy&amp;Borrow 可视化</a></li><li class="chapter-item expanded "><a href="../../programming-languages/rust/concepts/memory_layout.html"><strong aria-hidden="true">3.2.2.6.</strong> 内存布局可视化</a></li><li class="chapter-item expanded "><a href="../../programming-languages/rust/concepts/async_await.html"><strong aria-hidden="true">3.2.2.7.</strong> Async/Await</a></li><li class="chapter-item expanded "><a href="../../programming-languages/rust/concepts/pin_unpin.html"><strong aria-hidden="true">3.2.2.8.</strong> Pin/Unpin</a></li><li class="chapter-item expanded "><a href="../../programming-languages/rust/tao-of-rust.html"><strong aria-hidden="true">3.2.2.9.</strong> 《Rust 编程之道》阅读纪要</a></li></ol></li><li class="chapter-item expanded "><a href="../../programming-languages/c-style/c-style.html"><strong aria-hidden="true">3.2.3.</strong> C/C++/Objective-C</a></li></ol></li><li class="chapter-item expanded "><a href="../../cs/algorithms.html"><strong aria-hidden="true">3.3.</strong> 数据结构与算法</a></li><li class="chapter-item expanded "><a href="../../cs/compiliers.html"><strong aria-hidden="true">3.4.</strong> 编译原理</a></li><li class="chapter-item expanded "><a href="../../cs/networking/networking.html"><strong aria-hidden="true">3.5.</strong> 网络</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../cs/networking/tcp.html"><strong aria-hidden="true">3.5.1.</strong> TCP</a></li></ol></li><li class="chapter-item expanded "><a href="../../cs/database.html"><strong aria-hidden="true">3.6.</strong> 数据库</a></li><li class="chapter-item expanded "><a href="../../cs/terminology.html"><strong aria-hidden="true">3.7.</strong> 术语汇总</a></li></ol></li><li class="chapter-item expanded "><a href="../../software-development/software-development.html"><strong aria-hidden="true">4.</strong> 软件开发</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../software-development/engineering.html"><strong aria-hidden="true">4.1.</strong> 工程效率</a></li><li class="chapter-item expanded "><a href="../../iOSDev/iOSDev.html"><strong aria-hidden="true">4.2.</strong> iOS 开发</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../iOSDev/architecture.html"><strong aria-hidden="true">4.2.1.</strong> 架构设计</a></li><li class="chapter-item expanded "><a href="../../iOSDev/threading-programming/threading-programming.html"><strong aria-hidden="true">4.2.2.</strong> 多线程编程</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../iOSDev/threading-programming/about.html"><strong aria-hidden="true">4.2.2.1.</strong> 关于多线程编程</a></li><li class="chapter-item expanded "><a href="../../iOSDev/threading-programming/thread-management.html" class="active"><strong aria-hidden="true">4.2.2.2.</strong> 线程管理</a></li><li class="chapter-item expanded "><a href="../../iOSDev/threading-programming/run-loops.html"><strong aria-hidden="true">4.2.2.3.</strong> Run Loops</a></li><li class="chapter-item expanded "><a href="../../iOSDev/threading-programming/synchronization.html"><strong aria-hidden="true">4.2.2.4.</strong> 线程同步</a></li></ol></li><li class="chapter-item expanded "><a href="../../iOSDev/performance.html"><strong aria-hidden="true">4.2.3.</strong> 性能优化</a></li><li class="chapter-item expanded "><a href="../../iOSDev/build-optimization.html"><strong aria-hidden="true">4.2.4.</strong> 编译优化</a></li><li class="chapter-item expanded "><a href="../../iOSDev/ui-layout.html"><strong aria-hidden="true">4.2.5.</strong> 视图布局</a></li><li class="chapter-item expanded "><a href="../../iOSDev/swift-ui.html"><strong aria-hidden="true">4.2.6.</strong> SwiftUI</a></li><li class="chapter-item expanded "><a href="../../iOSDev/database.html"><strong aria-hidden="true">4.2.7.</strong> 数据库</a></li><li class="chapter-item expanded "><a href="../../iOSDev/av.html"><strong aria-hidden="true">4.2.8.</strong> 音视频</a></li><li class="chapter-item expanded "><a href="../../iOSDev/community.html"><strong aria-hidden="true">4.2.9.</strong> 开发社区</a></li><li class="chapter-item expanded "><a href="../../iOSDev/xcode.html"><strong aria-hidden="true">4.2.10.</strong> Xcode</a></li><li class="chapter-item expanded "><a href="../../iOSDev/apps.html"><strong aria-hidden="true">4.2.11.</strong> iOS 应用</a></li></ol></li><li class="chapter-item expanded "><a href="../../software-development/android.html"><strong aria-hidden="true">4.3.</strong> Android 开发</a></li></ol></li><li class="chapter-item expanded "><a href="../../life/life.html"><strong aria-hidden="true">5.</strong> 丰富生活</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../life/stories.html"><strong aria-hidden="true">5.1.</strong> 故事</a></li></ol></li><li class="chapter-item expanded "><a href="../../work/work.html"><strong aria-hidden="true">6.</strong> 积极工作</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../work/job-hunt.html"><strong aria-hidden="true">6.1.</strong> 求职</a></li><li class="chapter-item expanded "><a href="../../work/career.html"><strong aria-hidden="true">6.2.</strong> 职场发展</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../work/articles/better-engineer.html"><strong aria-hidden="true">6.2.1.</strong> 工程师的成长</a></li></ol></li><li class="chapter-item expanded "><a href="../../work/remote.html"><strong aria-hidden="true">6.3.</strong> 远程工作</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../work/articles/how-to-get-a-remote-job-by-writing-in-english.html"><strong aria-hidden="true">6.3.1.</strong> 如何通过英文写作找到国外的远程工作机会</a></li></ol></li><li class="chapter-item expanded "><a href="../../work/slashie.html"><strong aria-hidden="true">6.4.</strong> 延伸拓展</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../product/product.html"><strong aria-hidden="true">6.4.1.</strong> 产品</a></li><li class="chapter-item expanded "><a href="../../design/design.html"><strong aria-hidden="true">6.4.2.</strong> 设计</a></li></ol></li></ol></li><li class="chapter-item expanded "><a href="../../open-source/open-source.html"><strong aria-hidden="true">7.</strong> 开源世界</a></li><li><ol class="section"><li class="chapter-item expanded "><a href="../../open-source/github.html"><strong aria-hidden="true">7.1.</strong> GitHub</a></li><li class="chapter-item expanded "><a href="../../open-source/meet-geniuses.html"><strong aria-hidden="true">7.2.</strong> 遇见天才</a></li></ol></li></ol>
        </div>
        <div id="sidebar-resize-handle" class="sidebar-resize-handle"></div>
    </nav>

    <div id="page-wrapper" class="page-wrapper">

        <div class="page">
            <div id="menu-bar-hover-placeholder"></div>
            <div id="menu-bar" class="menu-bar sticky bordered">
                <div class="left-buttons">
                    <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents"
                        aria-label="Toggle Table of Contents" aria-controls="sidebar">
                        <i class="fa fa-bars"></i>
                    </button>
                    <button id="theme-toggle" class="icon-button" type="button" title="Change theme"
                        aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                        <i class="fa fa-paint-brush"></i>
                    </button>
                    <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                        <li role="none"><button role="menuitem" class="theme" id="light">Light (default)</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                        <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button>
                        </li>
                    </ul>
                    <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)"
                        aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S"
                        aria-controls="searchbar">
                        <i class="fa fa-search"></i>
                    </button>
                </div>

                <h1 class="menu-title">棒棒彬的第二大脑</h1>

                <div class="right-buttons">
                    <a href="../../print.html" title="Print this book" aria-label="Print this book">
                        <i id="print-button" class="fa fa-print"></i>
                    </a>
                    <a href="https://github.com/Binlogo/Knowledge-Track" title="Git repository" aria-label="Git repository">
                        <i id="git-repository-button" class="fa fa-github"></i>
                    </a>
                    <a href="https://github.com/Binlogo/Knowledge-Track/edit/main/src/iOSDev/threading-programming/thread-management.md" title="Suggest an edit" aria-label="Suggest an edit">
                        <i id="git-edit-button" class="fa fa-edit"></i>
                    </a>
                </div>
            </div>

            <div id="search-wrapper" class="hidden">
                <form id="searchbar-outer" class="searchbar-outer">
                    <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..."
                        aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                </form>
                <div id="searchresults-outer" class="searchresults-outer hidden">
                    <div id="searchresults-header" class="searchresults-header"></div>
                    <ul id="searchresults">
                    </ul>
                </div>
            </div>
            <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
            <script type="text/javascript">
                document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                Array.from(document.querySelectorAll('#sidebar a')).forEach(function (link) {
                    link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                });
            </script>

            <div id="content" class="content">
                <main>
                    <h1 id="线程管理"><a class="header" href="#线程管理">线程管理</a></h1>
<p>每个进程都至少有一个线程，每个线程代表了一条执行代码的独立路径。应用从一个线程的 <code>main</code> 函数开始运行，然后产生新的线程。<strong>每个线程在进程内部都是独立的实体，具有自己的调用栈，并由内核做时分调度。<strong>线程可以与其他线程和进程</strong>通信</strong>，<strong>执行 I/O 操作</strong>等。一个应用进程内部的所有现场<strong>共享虚拟内存空间</strong>，并与进程拥有相同的访问权限。</p>
<h2 id="线程成本"><a class="header" href="#线程成本">线程成本</a></h2>
<p>使用线程对应用和系统来说都是有成本的，具体体现在<strong>内存使用和性能</strong>上。每个线程需要占用内核内存空间和程序内存空间。内核会使用联动(wired)内存为线程创建用于管理线程和协调调度的数据结构。线程的栈空间和数据存储在程序的内存空间中。这些数据结构大部分会在创建线程的时候初始化，进程也因与内核有必要的交互而成本变得相对更高。</p>
<table><thead><tr><th align="left">成本项</th><th align="left">大致成本</th><th align="left">注释</th></tr></thead><tbody>
<tr><td align="left">内核数据结构</td><td align="left">大约 1 KB</td><td align="left">用于存储线程数据结构和属性的内存，很多都是联动（wired）内存，所以不能在磁盘上分页</td></tr>
<tr><td align="left">栈空间</td><td align="left">次级线程：512 KB ; macOS 主线程：8 MB ; iOS 主线程：1 MB</td><td align="left">次级线程的栈空间最小为 16 KB，且必须是 4 KB 的整数倍。创建线程的时候可以设置栈空间的大小，但是只有在需要用它的时候才会创建真的分页内存。</td></tr>
<tr><td align="left">创建时间</td><td align="left">大约 90 微秒（macOS 10.5，2 GHz Core Duo CPU，1 GB RAM）</td><td align="left">从开始创建线程到线程入口函数开始执行的耗时，是个粗略的估值。处理器负载、计算机速度、系统和程序可用内存都会对创建时间造成较大的影响。</td></tr>
</tbody></table>
<p>由于底层内核的支持，operation objects 经常可以更快地创建线程。它使用<strong>内核线程池</strong>中已经存在的线程来节省创建时间，而不是每次都从零开始创建线程。</p>
<p>线程相关代码的开发工作也是一种<strong>生产成本</strong>。设计多线程程序有时需要对应用数据结构的组织方式进行彻底的改变。<strong>避免使用同步</strong>，因为它在设计较差的应用上会严重降低性能。设计数据结构和 debug 线程相关代码都会增加开发成本。</p>
<h2 id="创建线程"><a class="header" href="#创建线程">创建线程</a></h2>
<p>创建线程需要指定入口主函数，并可设置一些线程的配置项。最后调用运行线程的方法。下面介绍几种创建线程的技术。</p>
<h3 id="使用-thread"><a class="header" href="#使用-thread">使用 <code>Thread</code></a></h3>
<p>使用 <code>Thread</code> 创建线程有两种方式：</p>
<ol>
<li>使用 <a href="https://developer.apple.com/documentation/foundation/thread/1415633-detachnewthreadselector"><code>detachNewThreadSelector(_:toTarget:with:)</code></a> 类方法产生新的线程</li>
<li>创建一个新的 <code>Thread</code> 对象，并调用它的 <code>start</code> 方法。仅支持 iOS 和 macOS 10.5 以后的版本。</li>
</ol>
<p>这两种方法都会创建一个 <strong>detached</strong> 线程，它<strong>退出后系统会自动回收其资源</strong>，无需手动 join 操作。</p>
<p>下面两种创建线程的代码是等效的，但是推荐使用第二种方式。因为它支持在运行线程之前<strong>设置各种线程属性</strong>，不像第一种方式那样创建线程的时候必须立刻运行。</p>
<pre><code class="language-swift">// 方式 1
Thread.detachNewThreadSelector(#selector(myThreadMainMethod), toTarget: self, with: nil)

// 方式 2（推荐）
let myThread = Thread(target: self, selector: #selector(myThreadMainMethod), object: nil)
myThread.start()  // 实际创建线程
</code></pre>
<p>如果不想使用 <code>init(target:selector:object:)</code> 方法传入线程的入口函数，也可以继承 <code>Thread</code>，并覆写子类的 <code>main</code> 方法（不用调用 <code>super</code> 方法）。</p>
<p><code>perform(_:on:with:waitUntilDone:)</code> 方法可以在正在运行的线程发送消息，前提是这个线程必须有运行中的 run loop，因为消息会在线程的 run loop 处理过程中被执行。**注意使用此方法进行跨线程通信时需要有同步机制。**此方法并不适合用于实现对高即时性有一定要求和频繁的跨线程通信。</p>
<h3 id="使用-posix-线程"><a class="header" href="#使用-posix-线程">使用 POSIX 线程</a></h3>
<p>iOS 和 macOS 提供了基于 C 语言的 POSIX 线程 API 来创建线程，优点是跨平台。创建线程的函数是 <code>pthread_create</code>，默认<strong>创建的是 joinable 线程</strong>，所以需要设置线程属性来将其创建为 detached 线程，这样当线程退出的时候其资源就会立刻被系统回收利用了。</p>
<p>对于 C 语言的应用，可以使用端口、条件变量或共用内存来跨线程通信。跨线程通信有便于主线程检查其他线程的状态，在应用退出时做一些操作。</p>
<h3 id="使用-nsobject-产生线程"><a class="header" href="#使用-nsobject-产生线程">使用 <code>NSObject</code> 产生线程</a></h3>
<p>iOS 和 macOS 10.5 之后 <code>NSObject</code> 提供了<code>performSelectorInBackground:withObject:</code> 方法，可以让所有对象都创建 detached 线程，并传入 <code>selector</code> 作为入口函数。跟它等效的方法是 <code>NSThread</code> 的 <code>detachNewThreadSelector:toTarget:withObject:</code>。在 <code>selector</code> 方法里可以继续配置线程，比如添加 <code>autoreleasepool</code> 和 run loop。</p>
<h3 id="在-cocoa-应用中使用-posix-线程"><a class="header" href="#在-cocoa-应用中使用-posix-线程">在 Cocoa 应用中使用 POSIX 线程</a></h3>
<p>在 Cocoa 中使用 POSIX 线程需要注意它们之间的交互，并遵守以下原则。</p>
<h4 id="保护-cocoa-框架"><a class="header" href="#保护-cocoa-框架">保护 Cocoa 框架</a></h4>
<p>**Cocoa 框架使用加锁之类的同步机制来确保多线程工作正常，但只有在第一次使用 <code>Thread</code> 产生新线程的时候才会真的创建锁。这可以避免单线程情况下加锁会降低性能。**但如果只使用 POSIX API 来产生新线程，Cocoa 就不会收到应用转换为多线程的通知，进而导致应用不稳定，甚至 crash。可以用 <code>Thread</code> 创建一个新线程，入口函数啥都不做，这样线程就会立刻退出。这样 Cocoa 就知道应用处于多线程了，加锁也会生效。</p>
<p>PS：这么抖机灵的做法当然也会产生创建线程的开销，有些违背之前说的不要随意创建线程的原则。</p>
<p><code>Thread</code> 的 <code>isMultiThreaded</code> 方法可以检查应用是否是多线程。</p>
<h4 id="混合使用-posix-和-cocoa-锁"><a class="header" href="#混合使用-posix-和-cocoa-锁">混合使用 POSIX 和 Cocoa 锁</a></h4>
<p>在一个应用中混合使用 POSIX 和 Cocoa 两套 API 的锁是安全的，因为后者实质上只是对前者的封装。但不能用一种 API 的方法操作另一种 API 创建的锁。比如不能使用 <code>NSLock</code> 对象操作 <code>pthread_mutex_init</code> 函数创建的互斥锁，反之亦然。</p>
<h2 id="配置线程属性"><a class="header" href="#配置线程属性">配置线程属性</a></h2>
<h3 id="配置线程的栈尺寸"><a class="header" href="#配置线程的栈尺寸">配置线程的栈尺寸</a></h3>
<p>创建线程后系统会为其创建一块内存作为栈空间，开发者可以在创建线程前配置这块空间的尺寸。所有的线程技术都会提供某种设置栈尺寸的方法，但 <code>Thread</code> 只有在 iOS 和 macOS 10.5 之后支持设置栈的尺寸。</p>
<table><thead><tr><th align="left">技术</th><th align="left">选项</th></tr></thead><tbody>
<tr><td align="left">Cocoa</td><td align="left">前提是不要使用 <code>detachNewThreadSelector(_:toTarget:with:)</code> 创建线程。创建线程对象后，在调用线程对象的 <code>start</code> 方法之前，使用 <code>setStackSize:</code> 方法指定栈的大小。</td></tr>
<tr><td align="left">POSIX</td><td align="left">创建 <code>pthread_attr_t</code> 栈属性结构体并使用 <code>pthread_attr_setstacksize</code> 函数修改默认的栈尺寸。在使用 <code>pthread_create</code> 函数创建线程时将属性结构体传入。</td></tr>
<tr><td align="left">Multiprocessing Services</td><td align="left">使用 <code>MPCreateTask</code> 函数创建线程时可以传入栈尺寸。</td></tr>
</tbody></table>
<h3 id="配置-tlsthread-local-storage"><a class="header" href="#配置-tlsthread-local-storage">配置 TLS(Thread-Local Storage)</a></h3>
<p>每个线程都维护了一个存储键值对的字典，在线程内随处都能存取。可以用它<strong>记录一些贯穿于线程执行过程中的信息，比如 run loop 迭代次数。</strong></p>
<p>Cocoa 与 POSIX 存储线程字典的方式不同，所以两种技术的 API 不能混用。始终用其中一种技术。</p>
<p>具体方式如下：</p>
<ul>
<li>Cocoa: <code>Thread</code> 的 <a href="https://developer.apple.com/documentation/foundation/thread/1411433-threaddictionary"><code>threadDictionary</code></a> 方法获取 <code>NSMutableDictionary</code> 字典对象，然后进行存取。</li>
<li>POSIX: 直接用 <code>pthread_setspecific</code> 和 <code>pthread_getspecific</code> 函数存取字典。</li>
</ul>
<h3 id="设置线程的-detached-状态"><a class="header" href="#设置线程的-detached-状态">设置线程的 Detached 状态</a></h3>
<p>大部分高级线程技术创建的线程默认都是 detached 状态，这是因为大部分场景下都需要系统在线程执行完成后立刻回收资源。好处是代码干净，是否获取线程执行结果可以自行决定。</p>
<p>joinable 线程需要其他线程调用 <code>pthread_join</code> 函数对其进行 join 操作之后才能被系统回收资源。joinable 线程可以向 <code>pthread_exit</code> 函数传入数据，其他线程可以在调用 <code>pthread_join</code> 函数的时候获得此数据。参考 <a href="https://stackoverflow.com/questions/8513894/pthread-join-and-pthread-exit">pthread_join() and pthread_exit()</a>。</p>
<p>应用退出时，detached 线程可以立刻结束，但是 joinable 线程必须全都被 join 后进程才能退出。<strong>因此 joinable 线程适用于执行不能中断的重要工作，比如向磁盘写入数据。</strong></p>
<p>只能用 POSIX API 来创建 joinable 线程，如果不设置线程属性，默认就是 joinable 线程。可以在创建线程之前调用 <code>pthread_attr_setdetachstate</code> 函数修改线程 detached 状态。在线程开始运行之后，可以调用 <code>pthread_detach</code> 函数将一个 joinable 线程变成 detached 线程。</p>
<h3 id="设置线程优先级"><a class="header" href="#设置线程优先级">设置线程优先级</a></h3>
<p>任何新创建的线程都有个默认优先级。内核的调度算法在决定运行哪个线程的时候都会考虑到线程优先级，优先级越高越可能先运行。<strong>拥有更高优先级的线程并不保证有特定的运行时间，只是在与低优先级线程比较时更容易被调度算法选中罢了。</strong></p>
<p><strong>最好让你创建的线程保持默认优先级</strong>。提升一些线程的优先级也会提升低优先级线程饥饿的可能性。如果高优先级线程和低优先级线程之间有交互，低优先级线程饥饿可能会阻塞其他线程，并造成性能瓶颈。(<strong>优先级倒置</strong>)</p>
<p>设置线程优先级的方式如下：</p>
<ul>
<li>Cocoa: <code>Thread</code> 的 <code>setThreadPriority:</code> 类方法可以设置当前线程的优先级。</li>
<li>POSIX: <code>pthread_setschedparam</code> 函数设置优先级。</li>
</ul>
<h2 id="编写线程入口程序"><a class="header" href="#编写线程入口程序">编写线程入口程序</a></h2>
<p>各平台上的线程入口函数结构都差不多，一般都会初始化数据结构，执行一些工作，或者使用 run loop 保活，最后在工作完成后清理占用的资源。这里讲一下编写线程入口程序需要做的一些额外步骤。</p>
<h3 id="创建自动释放池"><a class="header" href="#创建自动释放池">创建自动释放池</a></h3>
<p>使用 Objective-C 框架的应用必须<strong>确保每条线程至少有一个自动释放池</strong>。</p>
<p>使用 <code>@autoreleasepool</code> 创建自动释放池比 <code>NSAutoreleasePool</code> 更方便。而且 <code>NSAutoreleasePool</code> 不能在 ARC 下使用。</p>
<pre><code class="language-swift">@objc func myThreadMainMethod() {
    autoreleasepool {
        // Do thread work here
    }
}
</code></pre>
<p>有时需要创建更多的自动释放池，比如在循环内部使用自动释放池降低内存开销。</p>
<h3 id="设置-exception-handler"><a class="header" href="#设置-exception-handler">设置 Exception Handler</a></h3>
<p>未被捕获的异常会导致应用崩溃，虽然最好应该在异常发生的地方进行异常处理，但是在线程的入口函数再加上个 try/catch 比较好。</p>
<p>更多内容参考： <a href="https://developer.apple.com/library/content/documentation/Cocoa/Conceptual/Exceptions/Exceptions.html#//apple_ref/doc/uid/10000012i">Exception Programming Topics</a></p>
<h3 id="设置-run-loop"><a class="header" href="#设置-run-loop">设置 Run Loop</a></h3>
<p>编写线程上运行的代码有两种选择：</p>
<ol>
<li>代码简单粗暴，任务执行完线程就退出了；</li>
<li>设置线程的 run loop，处理不断到来的请求。</li>
</ol>
<p>macOS 和 iOS 内置了 run loop 的实现，应用的主线程自动开启 run loop。开发者创建的次级线程需要手动配置和开启 run loop。</p>
<p>更多内容参考：<a href="./run-loops.html">Run Loops</a></p>
<h2 id="终止线程"><a class="header" href="#终止线程">终止线程</a></h2>
<p>建议让线程的入口函数正常退出。虽然 Cocoa，POSIX 和 Multiprocessing Services 提供了直接杀线程的方法，但强烈不建议使用。<strong>强杀线程会导致无法回收资源，可能导致内存泄露、资源没被正确清理，进而导致后续的隐患</strong>。</p>
<p>如果预料到需要中途结束线程，设计线程之初就应该响应到取消或退出的消息。带有 run loop 这种周期操作的线程可以每次查看是否收到退出的消息。如果需要退出线程，则可以清理线程资源后退出；否则继续处理其他工作。</p>
<p>run loop 可以使用 input source 接受其他线程发的消息，但需要为 <code>RunLoop</code> 配置 <code>CFRunLoopSourceRef</code>，假设这部分代码在 <code>myInstallCustomInputSource</code> 已经实现好了。下面的代码还省略了 <code>while</code> 主循环中做的实际工作。将标记是否需要退出线程的局部变量 <code>exitNow</code> 的值放在 TLS 中同步是为了方便 input source 的事件处理函数对 <code>exitNow</code> 的存取，因为事件处理是在另外一个函数，不能直接存取 <code>exitNow</code>，需要利用 <a href="#%E9%85%8D%E7%BD%AE-tlsthread-local-storage">TLS</a>。当 input source 收到退出消息后，对应的事件处理函数便可以清理线程的资源，准备退出。</p>
<pre><code class="language-swift">@objc func threadMainRoutine() {
    autoreleasepool {
        var moreWorkToDo = true
        var exitNow = false
        let runLoop = RunLoop.current

        // Add the exitNow BOOL to the thread dictionary.
        let threadDict = Thread.current.threadDictionary
        threadDict.setValue(exitNow, forKey: &quot;ThreadShouldExitNow&quot;)

        // Install an input source.
        self.myInstallCustomInputSource()

        while moreWorkToDo &amp;&amp; !exitNow {
            // Do one chunk of a larger body of work here.
            // Change the value of the moreWorkToDo Boolean when done.

            // Run the run loop but timeout immediately if the input source isn't waiting to fire.
            runLoop.run(until: Date())

            exitNow = threadDict.value(forKey: &quot;ThreadShouldExitNow&quot;)
        }
    }
}
</code></pre>

                    <!-- Comments powered by giscus.app -->
                    <div id="comments" class="giscus">
                        <script src="https://giscus.app/client.js" data-repo="Binlogo/Knowledge-Track"
                            data-repo-id="MDEwOlJlcG9zaXRvcnkyNDc1MTA2ODg=" data-category="Announcements"
                            data-category-id="DIC_kwDODsC2oM4B_hm2" data-mapping="pathname" data-reactions-enabled="1"
                            data-emit-metadata="0" data-theme="light" crossorigin="anonymous" async>
                            </script>
                    </div>
                </main>

                <nav class="nav-wrapper" aria-label="Page navigation">
                    <!-- Mobile navigation buttons -->
                    <a rel="prev" href="../../iOSDev/threading-programming/about.html" class="mobile-nav-chapters previous"
                        title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                    <a rel="next" href="../../iOSDev/threading-programming/run-loops.html" class="mobile-nav-chapters next"
                        title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                    <div style="clear: both"></div>
                </nav>
            </div>
        </div>

        <nav class="nav-wide-wrapper" aria-label="Page navigation">
            <a rel="prev" href="../../iOSDev/threading-programming/about.html" class="nav-chapters previous" title="Previous chapter"
                aria-label="Previous chapter" aria-keyshortcuts="Left">
                <i class="fa fa-angle-left"></i>
            </a>
            <a rel="next" href="../../iOSDev/threading-programming/run-loops.html" class="nav-chapters next" title="Next chapter"
                aria-label="Next chapter" aria-keyshortcuts="Right">
                <i class="fa fa-angle-right"></i>
            </a>
        </nav>

    </div>

    <!-- Google Analytics Tag -->
    <script type="text/javascript">
        var localAddrs = ["localhost", "127.0.0.1", ""];

        // make sure we don't activate google analytics if the developer is
        // inspecting the book locally...
        if (localAddrs.indexOf(document.location.hostname) === -1) {
            (function (i, s, o, g, r, a, m) {
                i['GoogleAnalyticsObject'] = r; i[r] = i[r] || function () {
                    (i[r].q = i[r].q || []).push(arguments)
                }, i[r].l = 1 * new Date(); a = s.createElement(o),
                    m = s.getElementsByTagName(o)[0]; a.async = 1; a.src = g; m.parentNode.insertBefore(a, m)
            })(window, document, 'script', 'https://www.google-analytics.com/analytics.js', 'ga');

            ga('create', 'UA-160717450-2', 'auto');
            ga('send', 'pageview');
        }
    </script>
    <script type="text/javascript">
        window.playground_copyable = true;
    </script>
    <script src="../../elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../mark.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../searcher.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../clipboard.min.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../highlight.js" type="text/javascript" charset="utf-8"></script>
    <script src="../../book.js" type="text/javascript" charset="utf-8"></script>

    <!-- Custom JS scripts -->
</body>

</html>